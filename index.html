<script>
  async function getExchangeRateWithCommission() {
    try {
      const response = await fetch('https://api.exchangerate.host/latest?base=RUB&symbols=VND');
      const data = await response.json();
      console.log('Ответ API:', data);

      if (data && data.rates && data.rates.VND) {
        const rubToVnd = data.rates.VND;
        const vndToRub = 1 / rubToVnd;
        const rateWithCommission = vndToRub * 0.92; // 8% выгода для тебя
        return rateWithCommission;
      } else {
        throw new Error('Нет курса RUB→VND');
      }
    } catch (error) {
      alert('Ошибка получения курса валют: ' + error.message);
      return null;
    }
  }

  const vndInput = document.getElementById('vndAmount');
  const convertBtn = document.getElementById('convertBtn');
  const resultBlock = document.getElementById('result');
  const rubAmountSpan = document.getElementById('rubAmount');
  const paymentDetails = document.getElementById('paymentDetails');
  const sendBtn = document.getElementById('sendBtn');
  const statusText = document.getElementById('status');
  const receiptInput = document.getElementById('paymentReceipt');

  convertBtn.onclick = async () => {
    const vnd = parseFloat(vndInput.value);
    if (!vnd || vnd <= 0) {
      alert('Введите корректную сумму в VND');
      return;
    }

    const exchangeRate = await getExchangeRateWithCommission();
    if (!exchangeRate) return;

    const rub = (vnd * exchangeRate).toFixed(2);
    rubAmountSpan.textContent = rub;
    paymentDetails.textContent = `Получатель: ООО "Пример"\nСчёт: 1234567890\nБанк: Примербанк\nИНН: 123456789\n...`;
    resultBlock.style.display = 'block';
    statusText.textContent = '';
  };

  sendBtn.onclick = () => {
    const vnd = parseFloat(vndInput.value);
    const rub = rubAmountSpan.textContent;
    const file = receiptInput.files[0];

    if (!vnd || !rub) {
      alert('Сначала посчитайте сумму');
      return;
    }

    if (!file) {
      alert('Загрузите чек оплаты');
      return;
    }

    const formData = new FormData();
    formData.append('vnd', vnd);
    formData.append('rub', rub);
    formData.append('receipt', file);

    statusText.textContent = 'Отправка...';

    fetch('https://твоя_домен_или_ip/api/payment', {
      method: 'POST',
      body: formData,
    })
    .then(res => {
      if (res.ok) {
        statusText.textContent = 'Данные успешно отправлены! Спасибо.';
        vndInput.value = '';
        receiptInput.value = '';
        resultBlock.style.display = 'none';
      } else {
        statusText.textContent = 'Ошибка отправки. Попробуйте позже.';
      }
    })
    .catch(() => {
      statusText.textContent = 'Ошибка сети. Попробуйте позже.';
    });
  };
</script>
